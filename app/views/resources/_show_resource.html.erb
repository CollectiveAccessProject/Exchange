
<% parent = @resource.parents.first %>
<%= render partial: 'show_parent_heading.html.erb' %>

<div class="row">
  <div class="col-sm-12">
    <H4>
      <% if (params['mode'] == :preview) %>
          Previewing Resource
      <% end %>
      <div class='headingButtons'>
      <%= link_to '<span class="glyphicon glyphicon-edit aria-hidden="true"></span> Edit'.html_safe, edit_resource_path(@resource), class:'btn btn-default btn-xs' %>
      <%= link_to '<span class="glyphicon glyphicon-arrow-up aria-hidden="true"></span> Dashboard'.html_safe, '/dashboard', class:'btn btn-default btn-xs' %>
      <%= last_search_button(session, {'class': 'btn btn-default btn-xs'}) %>
	  </div>
    </H4>
  </div><!-- end col -->
</div><!-- end row -->

<div class="row">
  <div class="col-sm-10">
    <p id="notice"><%= notice %></p>

    <H2><%= @resource.title %></H2>
    <H3><%= @resource.subtitle %></H3>
<% if @resource.settings(:text_placement).placement.to_s == "above" %>
    <% if @resource.settings(:text_formatting).show_all == 1 %>
    	<% if @resource.parsed_body_text.length > 400 %>
			<div class="row">
				<div class="<%= (@resource.settings(:text_formatting).collapse == 1) ? 'col-md-12 textSwap' : 'collapse col-md-12 textSwap' %>" aria-controls="fullTextExpand">
					<p><%= truncate(@resource.parsed_body_text, length: 400, escape: false, separator: "&nbsp;") %></p>
				</div>
				<div class="<%= (@resource.settings(:text_formatting).collapse == 1) ? 'collapse col-md-12 textSwap' : 'col-md-12 textSwap' %>" aria-controls="fullTextExpand">
					<p><%= @resource.parsed_body_text.html_safe %></p>
				</div>
			</div>
			<div class="row">
				<div class="col-md-4 col-md-offset-4 text-center">
					<a role="button" data-toggle="collapse" href="#fullTextField" aria-expanded="false" aria-controls="fullTextExpand" onclick="$('.hideText, .textSwap').toggle('slow')">
						<div class="<%= (@resource.settings(:text_formatting).collapse == 1) ? 'hideText' : 'hideText collapse' %>"><h4><i class="fa fa-chevron-down" aria-hidden="true"></i> Show Full Description <i class="fa fa-chevron-down" aria-hidden="true"></i></h4></div>
						<div class="<%= (@resource.settings(:text_formatting).collapse == 1) ? 'hideText collapse' : 'hideText' %>"><h4><i class="fa fa-chevron-up" aria-hidden="true"></i> Hide Full Description <i class="fa fa-chevron-up" aria-hidden="true"></i></h4></div>
					</a>
				</div>
			</div>
		<% else %>
			<div class="row">
				<div class="col-sm-12">
					<%= @resource.parsed_body_text.html_safe %>
				</div>
			</div>
		<% end %>
	<% else %>
		<div class="row">
  			<div class="col-md-12 textSwap">
    			<p><%= @resource.parsed_body_text.html_safe %></p>
			</div>
		</div>
	<% end %>
<% end %>

<%
	# generate count of publically available media files
	# need to enforce access control
	available_media = 0
	@resource.media_files.each do |f|
		if f.access == 1
			available_media = available_media + 1
		end
	end
			
	case @resource.settings(:media_formatting).mode.to_s
		when "thumbnails"
%>
            <div class="row">
<%
				counter = 0
				@resource.media_files.each do |f|
               		if f.sourceable
						if f.access == 1
							if counter == 4
								counter = 0
%>
								</div>
								<div class="row">
							<% end %>
							  <div class="col-md-3">
									<div class="thumbnail previewThumbnail">
									  <a href="#" data-toggle="modal" data-target="#<%= f.sourceable.class.to_s + f.sourceable.id.to_s %>">
										<%= f.sourceable.preview :thumbnail  %>
									  </a>
									</div>
<%
							begin
								media_display = f.sourceable.render(:large)
							rescue
								media_display = f.sourceable.preview :large	
							end
%>	
<%=
									# this renders a bootstrap model that is triggered if you click on the preview above
									# it's in a partial because it's about a billion nested divs :-)
									render partial: 'media_file_render_overlay', locals: { media: media_display, media_id: f.id.to_s,  modal_id: f.sourceable.class.to_s + f.sourceable.id.to_s, editable: false }
%>
							  </div><!-- end col -->
<%
				
							counter = counter + 1
						end
					end
            	end
%>
            </div><!-- end row -->
        
        <% when "thumbnailsCaption" %>
            <div class="row">
<%
				counter = 0
				@resource.media_files.each do |f|
					if f.access == 1
						if f.sourceable
							if counter == 4
								counter = 0
%>
								</div>
								<div class="row">
							<% end %>
							  <div class="col-md-3">
									<div class="thumbnail previewThumbnail">
									  <a href="#" data-toggle="modal" data-target="#<%= f.sourceable.class.to_s + f.sourceable.id.to_s %>">
										<%= f.sourceable.preview :thumbnail  %>
									  </a>
									  <div class="caption small">
										<%= f.caption.html_safe %>
									  </div>
									</div>
<%
							begin
								media_display = f.sourceable.render(:large)
							rescue
								media_display = f.sourceable.preview :large	
							end
%>	
<%=
									# this renders a bootstrap model that is triggered if you click on the preview above
									# it's in a partial because it's about a billion nested divs :-)
									render partial: 'media_file_render_overlay', locals: { media: media_display, media_id: f.id.to_s,  modal_id: f.sourceable.class.to_s + f.sourceable.id.to_s, editable: false }
%>
							  </div><!-- end col -->
<%
				
							counter = counter + 1
						end
					end
            	end
%>
            </div><!-- end row -->
<%
		when "slideshow"
		  if available_media > 0
%>

            <div class="row">
              <div class="col-sm-8 col-sm-offset-2">
				<div id="resourceCarousel" class="carousel slide" data-ride="carousel" data-interval="false">
					<!-- Wrapper for slides -->
					<div class="carousel-inner" role="listbox">
<%
				  counter = 1
				  @resource.media_files.each do |f| 
					if f.access == 1
						if f.sourceable 
%>
							<div class="item <%= (counter == 1) ? 'active' : '' %>">
									<a href="#" data-toggle="modal" data-target="#<%= f.sourceable.class.to_s + f.sourceable.id.to_s %>">
										<%= f.sourceable.preview :large  %>
									</a>
								<div class="captionContainer">
									<div class="slideshowCaption"><%= f.caption.html_safe  %></div>
								</div>
							</div>		
<%
							begin
								media_display = f.sourceable.render :large
							rescue
								media_display = f.sourceable.preview :large	
							end
%>					
<%=
							# this renders a bootstrap model that is triggered if you click on the preview above
							# it's in a partial because it's about a billion nested divs :-)
						
							render partial: 'media_file_render_overlay', locals: { media: media_display, media_id: f.id.to_s,  modal_id: f.sourceable.class.to_s + f.sourceable.id.to_s, editable: false }
%>
<%
							counter = counter + 1
						end
					end
				end
%>
					</div><!-- end carousel-inner -->
<%
					if available_media > 1
%>
					  <!-- Left and right controls -->
					  <a class="left carousel-control" href="#resourceCarousel" role="button" data-slide="prev">
						<span class="control-arrow glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
						<span class="sr-only">Previous</span>
					  </a>
					  <a class="right carousel-control" href="#resourceCarousel" role="button" data-slide="next">
						<span class="control-arrow glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
						<span class="sr-only">Next</span>
					  </a>
					<% end %>
				</div><!-- end resourceCarousel -->
				</div>
			</div>
			<div class="row">
              <div class="col-sm-4 col-sm-offset-4 text-center">
				<h4><a href="#" data-toggle="modal" data-target="#carousel-full">Fullscreen slideshow</a></h4>	
				
				<% # This is in a partial because its a lot of nested divs and duplicates functionality in the main slideshow
				   # which is potentially confusing %>
				<%= render partial: 'resource_slideshow_fullscreen' %>
					
              </div><!-- end col -->
            </div><!-- end row -->
		<% 
		    end
		  end
		 %>
<% if @resource.settings(:text_placement).placement.to_s == "below" %>
    <% if @resource.settings(:text_formatting).show_all == 1 %>
		<% if @resource.parsed_body_text.length > 400 %>
			<div class="row">
				<div class="<%= (@resource.settings(:text_formatting).collapse == 1) ? 'col-md-12 textSwap' : 'collapse col-md-12 textSwap' %>" aria-controls="fullTextExpand">
					<p><%= truncate(@resource.parsed_body_text, length: 400, escape: false, separator: "&nbsp;") %></p>
				</div>
				<div class="<%= (@resource.settings(:text_formatting).collapse == 1) ? 'collapse col-md-12 textSwap' : 'col-md-12 textSwap' %>" aria-controls="fullTextExpand">
					<p><%= @resource.parsed_body_text.html_safe %></p>
				</div>
			</div>
			<div class="row">
				<div class="col-md-4 col-md-offset-4 text-center">
					<a role="button" data-toggle="collapse" href="#fullTextField" aria-expanded="false" aria-controls="fullTextExpand" onclick="$('.hideText, .textSwap').toggle('slow')">
						<div class="<%= (@resource.settings(:text_formatting).collapse == 1) ? 'hideText' : 'hideText collapse' %>"><h4><i class="fa fa-chevron-down" aria-hidden="true"></i> Show Full Description <i class="fa fa-chevron-down" aria-hidden="true"></i></h4></div>
						<div class="<%= (@resource.settings(:text_formatting).collapse == 1) ? 'hideText collapse' : 'hideText' %>"><h4><i class="fa fa-chevron-up" aria-hidden="true"></i> Hide Full Description <i class="fa fa-chevron-up" aria-hidden="true"></i></h4></div>
					</a>
				</div>
			</div>
		<% else %>
			<div class="row">
				<div class="col-sm-12">
					<%= @resource.parsed_body_text.html_safe %>
				</div>
			</div>
		<% end %>
	<% else %>
		<div class="row">
  			<div class="col-md-12 textSwap">
    			<p><%= @resource.parsed_body_text.html_safe %></p>
			</div>
		</div>
	<% end %>
<% end %>
	<div class="row">
	  <div class="col-md-12">
	    <div class="row" id="detailTags">
		  
		<% if(@resource.settings(:user_interaction).allow_comments > 0) %>
		  <div class="col-sm-6">
			<a id="commentButton" role="button" data-toggle="collapse" href="#commentPanel"><H4><%= @resource.comments.count %> Comment<%= @resource.comments.count == 1 ? '' : 's' %></H4></a>
			<div id="commentPanel" class="detailComments collapse">
			  <% @resource.comments.each do |c| %>
				<div>
				  <%= c.comment %>
				  <br/><small>&mdash; by <i><%= c.user_name %>  (<%= c.updated_at.to_time.strftime(Rails.application.config.x.timestamp_format) %>)</i></small>
				</div>
			  <% end %>
			  <%= form_tag '/resources/add_comment' do %>
				<%= hidden_field_tag 'id', @resource.id %>
				<div class="form-group">
				  <label>Add Comment</label>
				  <%= text_area_tag 'comment[comment]', nil, class:'form-control' %>
				</div>
				  <%= submit_tag 'Save', class:'btn btn-default btn-sm' %>
			  <% end %>
			</div>
		  </div>
		<% end %>
		<% if (@resource.settings(:user_interaction).allow_tags > 0) %>
			<div class="col-sm-6"> 
			  <a role="button" data-toggle="collapse" href="#tagPanel"><H4><%= @resource.tags.count %> Tag<%= @resource.tags.count == 1 ? '' : 's' %></h4></a>
			  <div id="tagPanel" class="collapse detailComments">
				<% @resource.tags.each do |t| %>
				  <%= t.tag %>, 
				<% end %>
				<%= form_tag '/resources/add_tag' do %>
				<%= hidden_field_tag 'id', @resource.id %>
				<div class="form-group">
				  <label>Add Tag</label>
				  <%= text_field_tag 'tag[tag]', nil, class:'form-control' %>
				</div>
				<%= submit_tag 'Save', class:'btn btn-default btn-sm' %>
				<% end %>
			  </div>
			</div>
		  <% end %>
	</div>
  </div>	  
</div>

</div><!-- end col -->
  <div class="col-sm-2 resourceSidePanel">
    <div class="panel panel-primary">
      <div class="panel-body">
		<div class="row">
			<div class="col-xs-7 text-left">
				<a href="#"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous</a>
			</div>
			<div class="col-xs-5 text-right">
				<a href="#">Next <i class="fa fa-arrow-circle-right" aria-hidden="true"></i></a>
			</div>
		</div>
		<div class="detailButtonsResource text-center">
			<a href="#" title="Duplicate and Edit"><i class="fa fa-clone" aria-hidden="true"></i></a>
			<a href="#" title="Share"><i class="fa fa-share" aria-hidden="true"></i></a>
<% if(@resource.settings(:user_interaction).allow_comments > 0) %>
			<a href="#commentButton"><i class="fa fa-comments-o" aria-hidden="true"></i></a>
<% end %>
          <span id="favoriteControl"><%= render partial: "favorites/favorite_control", locals: { resource: @resource} %></span>
		</div>
<%
	if(@resource.parents && (@resource.parents.count > 0))
%>
		<div class="unit">	
			<!--<h4>Part of <%= @resource.parents.count %> Learning Collection<%= (@resource.parents.count == 1) ? "" : "s" %></h4>-->
			<H4>More from this learning collection</H4>
		
		<% 
			panelCount = 0
			@resource.parents.each do |p|
	 %>
		
		  		<div><a role="button" data-toggle="collapse" href="#collPanel_<%= panelCount %>">
		  		<strong><%= p.title %></strong>: <%= p.resource_hierarchies.count %> Resource<%= (p.resource_hierarchies.count == 1) ? "" : "s" %></small></a></div>
		  		<div id="collPanel_<%= panelCount %>" class="collapse scrollList">
				<% p.resource_hierarchies.each do |rel| %>
					<div>
					<small>
						<% if (rel.child_resource.is_collection) %>
							<%= link_to "<i class='fa fa-folder-o'></i>".html_safe, resource_preview_path(rel.child_resource) %>
						<% end %>
						<%= link_to rel.child_resource.title, resource_preview_path(rel.child_resource) %>
						<br />
						<%= (rel.child_resource.subtitle.length > 50) ? rel.child_resource.subtitle[0..50] + "..." : rel.child_resource.subtitle %>
					</small><br/>
					</div>
				<% end %>
				</div>
		
			<% panelCount += 1 %>
			<% end %>
		</div><!-- end unit -->	
	<% end %>	
<% if @resource.related_resources.count > 0 %>
	  <div class="unit">
		<a role="button" data-toggle="collapse" href="#relatedPanel"><H4><%= @resource.related_resources.count %> Related Resource<%= @resource.related_resources.count == 1 ? '' : 's' %></H4></a>
		<div id="relatedPanel" class="collapse detailRelatedContentBlockScroll">
		<% @resource.related_resources.each do |r| %>
			<div>
			  <%= link_to ((r.related.is_resource) ? "" : "<i class='fa fa-folder-o'></i> ".html_safe) + r.related.title, resource_preview_path(r.related) %>
			  <% if (r.caption.length > 0) %>
			   <br/><small>
				 <%= r.caption %>
			   </small>
			  <% end %>

			</div>
		<% end %>
		</div>
	  </div><!-- end unit -->
<% end %>
        <% if @resource.links.count > 0 %>
            <div class="unit">
              <H4><%= @resource.links.count %> Link<%= ((@resource.links.count > 1) ? "s" : "") %></H4>
              <% @resource.links.each do |c| %>
                  <div>
                    <a href="<%= c.url %>" target="_blank" title="<%= c.url %>"><i class='fa fa-external-link' aria-hidden='true'></i> <%= (c.caption && (c.caption.length > 0)) ? c.caption : ((c.url.length > 20) ? c.url[0..17] + "..." : c.url) %></a>
                  </div>
              <% end %>
            </div>
        <% end %>
<% if(@resource.settings(:user_interaction).allow_tags > 0) %>
	<% if @resource.tags.count > 0 %>
        <div class="unit">
			<H4>Tags</H4>
			<% @resource.tags.each do |t| %>
			  <%= t.tag %>, 
			<% end %>
		</div>
    <% end %>
<% end %>
	<div>
	  <% if @resource.author_name && @resource.author_name != ''  %>
	    <h4>Created by</h4><%= @resource.author_name %>
	  <% else %>
	  	<h4>Created by</h4><%= @resource.user.name %>
	  <% end %>
	  <h4>Last Updated</h4><%= time_ago_in_words(@resource.updated_at) + ' ago' %>
    </div>
    <% if (@resource.copyright_license) %>
		<div class="unit">
		  <h4>Copyright</h4>
		  <%= @resource.get_license_type %>
			<% if (@resource.copyright_notes.present?) %>
				(<%= @resource.copyright_notes %>)
			<% end  %>
		</div>
    <% end %>
    </div>
	</div>
  </div><!-- end col -->
</div><!-- end row -->

<div id="results_resource">
  <div class="row">
    <div class="col-sm-12">
      <a href="#" onClick="$('#resourceResultsContainer').toggle(); return false;" class="btn btn-noBg btn-lg pull-right" style="margin-top:-6px;"><i class="fa fa-arrows-v" aria-hidden="true"></i></a>
      <h4>
        <%= @resources_count %> Resource<%= (@resources_count == 1) ? "" : "s" %>
        (page <%= @resources_page.to_s + "/" + @resources_num_pages.to_s %>)

        <div class="pull-right">
          <form class="searchPaging">
            <div class="searchFormElement">Results Per Page <%= select_tag("resource_num_items_per_page", options_for_select(itemsPerPageOptionList, @items_per_page_defaults['resource']), {id: "resource_num_items_per_page"}) %></div>
            <div class="searchFormElement">Sort by <%= select_tag("resource_sort", options_for_select(sortOptions('resource'), @sort_defaults['resource']), {id: "resource_sort"}) %></div>
          </form>
        </div>
      </h4>
    </div>
  </div>
  <div class="row" id="resourceResultsContainer">
    <div class="col-sm-12">

      <div id="resourceResults-status">
        <div class="flash-notice" id="resourceResults-status-message">

        </div>
      </div>

      <% if (current_user && @available_collections && (@available_collections.length > 0)) %>
          <div>
            <form class="resourceResultsAdd">
              Add checked results to collection <%=
              select_tag(:add_to_collection_id, options_from_collection_for_select(@available_collections, :id, lambda {|t| strip_tags(t.title)}), class:'', id:'resourceResultsAddToCollectionID')
            %>
              <%= button_tag "<span class='glyphicon glyphicon-plus-sign' aria-hidden='true'></span> Add".html_safe, href: "#", class: "btn btn-noBg btn-xs", id: "resourceResultsAddToCollection"  %>
            </form>
          </div>
      <% end %>


      <%
        col = 0
        thumb = false
      %>
      <%
        @resources.each do |r|
          #next if(r[:access] < 1)
          col = col+1
          if(col == 1)
      %>
              <div class="row">
          <%
            end
          %>
          <div class="col-md-2 qsResult">
            <% if (current_user && @available_collections && (@available_collections.length > 0)) %>
            <div class="qsResultCheckbox"><input type="checkbox" name="add_resource" value="<%= r.id.to_s %>" class="qsResultCheckbox"/></div>
            <% end %>

            <div style="margin-right: 10px">
            <% r.media_files.each do |f| %>
                <% if f.sourceable %>
                    <% if f.access == 1 %>
                        <%= link_to (f.sourceable.preview :thumbnail), get_resource_view_path(r[:id], user_signed_in?), class: "qsResultThumb" %><br/>
                        <% thumb = true %>
                        <% break %>
                    <% end %>
                <% end %>
            <% end %>
            </div>
            <% if(thumb == false) %>
                <%= link_to '<i class="fa fa-picture-o fa-5x fa-align-center thumbPlaceholder" aria-hidden="true"></i>'.html_safe, get_resource_view_path(r[:id], user_signed_in?) %><br/>
            <% end %>
            <div class="text-left qsResultText">
              <%= link_to sanitize(r[:title].html_safe, tags: %w(strong em a font b sup sub u), attributes: %w(href style)), get_resource_view_path(r[:id], user_signed_in?) %>
              <div class="qsMoreCaption">
                <%
                  if r.author_id
                    user_author = r.get_author_name.gsub(/\([\S]+\)/, '')
                  else
                    user_author = r.user.name
                  end
                %>
                <%
                  if (Time.now.to_i - r.updated_at.to_i) > 86400
                    display_time = r.updated_at.in_time_zone('Eastern Time (US & Canada)').strftime("%B %-d, %Y %l:%M %P").gsub(/(a|p)(m)/, '\1.\2.')
                  else
                    display_time = time_ago_in_words(r.updated_at) + ' ago'
                  end
                %>
                <%= "<div class='small'><b>Author</b> #{user_author}</div><div class='small'><b>Last Updated</b> #{display_time}</div>".html_safe %>
                <% if r.total_ratings > 0 %>
                    <div class='small'><strong>Average Rating: </strong><%= r.avg_rating %></div>
                <% end %>
              </div>
            </div>
            <% thumb = false %>
          </div>

          <%
            if(col == 6)
          %>
              </div>
              <div class="row">
          <%
            end

            end
          %>
      <% if (col > 0) %>
          </div><!-- end row -->
      <% end %>

      <div class='row'>
        <%=
          if(@resources_needs_previous_paging)

            ("<div class='col-sm-3 text-center'>" + link_to("Previous", query_results_path(type: "resource", page: @resources_page - 1, query: @query), { class: "btn btn-default search-next-btn", remote: true}) + "</div>").html_safe
          else
            "<div class='col-sm-3'></div>".html_safe
          end
        %>
        <div class='col-sm-6 text-center'>
          <%
            if (@resources_needs_previous_paging || @resources_needs_next_paging)
              s = 1
              e = @resources_num_pages

              if (e > 10)
                s = @resources_page - 5
                s = 1 if (s < 1)
                e = s + 9
              end

              for i in s..e do
          %>
                  <%=  (link_to(i, query_results_path(type: "resource", page: i, query: @query), { class: "btn search-next-btn " + ((i == @resources_page) ? "btn-exch-green" : "btn-default"), remote: true})).html_safe %>
              <%
                end
                end
              %>
        </div>
        <%=
          if(@resources_needs_next_paging)

            ("<div class='col-sm-3 text-center'>" + link_to("Next", query_results_path(type: "resource", page: @resources_page + 1, query: @query), { class: "btn btn-default search-next-btn", remote: true}) + "</div>").html_safe
          else
            "<div class='col-sm-3'></div>".html_safe
          end
        %>
      </div>
    </div>
  </div>
</div>

<script>
    jQuery(document).ready(function() {
        jQuery("#resource_num_items_per_page, #resource_sort").on('change', function(e) {
            jQuery.getJSON("<%= query_results_path(type: "resource", page: @resources_page, query: @query) %>/" + jQuery("#resource_num_items_per_page").val() + "/" + jQuery("#resource_sort").val(), function(data) {
                jQuery("#results_resource").html(data.html);
                return true;
            });
        });

        jQuery("#resourceResultsAddToCollection").on('click', function(e) {
            e.preventDefault();

            var add_to_collection_id = jQuery("#resourceResultsAddToCollectionID").val();

            var ids = jQuery("#results_resource input.qsResultCheckbox").map(function() {
                return jQuery(this).prop('checked') ? jQuery(this).val(): undefined;
            }).get()

            if (!ids || (ids.length == 0)) {
                jQuery("#resourceResults-status").slideDown(250);
                jQuery("#resourceResults-status-message").html("No items are checked");
                window.setTimeout(function() {
                    jQuery("#resourceResults-status").slideUp(250);
                }, 3000);
                return false;
            }

            jQuery.post("/resources/" + add_to_collection_id + "/add_child_resources", {"add_child_resource_ids[]": ids}, function(data) {
                var n = data.numAdded;
                existed_msg = (data.numExisting > 0) ? ((data.numExisting == 1) ? " (1 already exists)" :  " (" + data.numExisting + " already exist)") : "";

                jQuery("#resourceResults-status").slideDown(250);
                jQuery("#resourceResults-status-message").html(((n == 1) ? "Added 1 resource to collection" : "Added " + n + " resources to collection") + existed_msg);
                window.setTimeout(function() {
                    jQuery("#resourceResults-status").slideUp(250);
                }, 3000);

                jQuery("#results_resource input.qsResultCheckbox").prop('checked', false);
                return true;
            }, 'json');
            return false;
        });
    });
</script>
